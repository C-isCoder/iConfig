# 均衡负载
# upstream api.congxiaodan.cn {
#    server 127.0.0.1:6663;
#    server 127.0.0.1:6664;
# }

# port 80 default
server {
    listen                      80 default_server;
    listen                      [::]:80 default_server;
    server_name                 _;
    # rewrite                     ^(.*) https://$host$1 permanent;
    return 301                  https://$host$request_uri;
}

# port 443 default
server {
    listen                      443 ssl default_server;
    listen                      [::]:443 ssl default_server ;
    ssl                         on;
    server_name                 congxiaodan.cn www.congxiaodan.cn;
    ssl_certificate             /root/nginx/ssl/main/1_congxiaodan.cn_bundle.crt;
    ssl_certificate_key         /root/nginx/ssl/main/2_congxiaodan.cn.key;
        
    location / {
        root                    /root/nginx/www/site;
        index                   index.html index.htm;
    }

    error_page 404 /i_404.html;
    location = /i_404.html {
            root /root/nginx/www/error_page;
    }

    error_page 500 502 503 504 /i_50x.html;
    location = /i_50x.html {
            root /root/nginx/www/error_page;
    }
}

# API
server {
    listen                      443;
    ssl                         on;
    server_name                 api.congxiaodan.cn;
    ssl_certificate             /root/nginx/ssl/api/1_api.congxiaodan.cn_bundle.crt;
    ssl_certificate_key         /root/nginx/ssl/api/2_api.congxiaodan.cn.key;

    location / {
        proxy_set_header        Host $http_host;
        proxy_set_header        X-Forwarded-Host $http_host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        # proxy_pass              http://api.congxiaodan.cn/;
        proxy_pass              http://127.0.0.1:6663;
        client_max_body_size    100m;
    }
}

# CI
server {
    listen                      443;
    ssl                         on;
    server_name                 ci.congxiaodan.cn;
    ssl_certificate             /root/nginx/ssl/ci/1_ci.congxiaodan.cn_bundle.crt;
    ssl_certificate_key         /root/nginx/ssl/ci/2_ci.congxiaodan.cn.key;

    location / {
        proxy_set_header        Host $http_host;
        proxy_set_header        X-Forwarded-Host $http_host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass              http://127.0.0.1:8080;
        client_max_body_size    100m;
    }
    
    error_page 404 /i_404.html;
    location = /i_404.html {
            root /root/nginx/www/error_page;
    }

    error_page 500 502 503 504 /i_50x.html;
    location = /i_50x.html {
            root /root/nginx/www/error_page;
    }
}

# Doc
server {
    listen                      443;
    ssl                         on;
    server_name                 doc.congxiaodan.cn;
    ssl_certificate             /root/nginx/ssl/doc/1_doc.congxiaodan.cn_bundle.crt;
    ssl_certificate_key         /root/nginx/ssl/doc/2_doc.congxiaodan.cn.key;

    location / {
        # rewrite ^(.*)           https://api.congxiaodan.cn/swagger/index.html redirect;
        return 301                  https://api.congxiaodan.cn/swagger/index.html;
    }

    error_page 404 /i_404.html;
    location = /i_404.html {
            root /root/nginx/www/error_page;
    }

    error_page 500 502 503 504 /i_50x.html;
    location = /i_50x.html {
            root /root/nginx/www/error_page;
    }
}

# Test
server {
    listen                      443;
    ssl                         on;
    server_name                 test.congxiaodan.cn;
    ssl_certificate             /root/nginx/ssl/test/1_test.congxiaodan.cn_bundle.crt;
    ssl_certificate_key         /root/nginx/ssl/test/2_test.congxiaodan.cn.key;
    
    location / {
        proxy_set_header        Host $http_host;
        proxy_set_header        X-Forwarded-Host $http_host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass              http://127.0.0.1:6666;
        client_max_body_size    100m;
    }

    error_page 404 /i_404.html;
    location = /i_404.html {
            root /root/nginx/www/error_page;
    }

    error_page 500 502 503 504 /i_50x.html;
    location = /i_50x.html {
            root /root/nginx/www/error_page;
    }
}

# IDE
server {
    listen                      443;
    ssl                         on;
    server_name                 ide.congxiaodan.cn;
    ssl_certificate             /root/nginx/ssl/ide/1_ide.congxiaodan.cn_bundle.crt;
    ssl_certificate_key         /root/nginx/ssl/ide/2_ide.congxiaodan.cn.key;
    
    location / {
        proxy_set_header        Host $http_host;
        proxy_set_header        X-Forwarded-Host $http_host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass              http://127.0.0.1:7070;
        client_max_body_size    100m;
    }

    error_page 404 /i_404.html;
    location = /i_404.html {
            root /root/nginx/www/error_page;
    }

    error_page 500 502 503 504 /i_50x.html;
    location = /i_50x.html {
            root /root/nginx/www/error_page;
    }
}

# NAS
server {
    listen                      443;
    ssl                         on;
    server_name                 nas.congxiaodan.cn;
    ssl_certificate             /root/nginx/ssl/nas/1_nas.congxiaodan.cn_bundle.crt;
    ssl_certificate_key         /root/nginx/ssl/nas/2_nas.congxiaodan.cn.key;
    
    location / {
        # rewrite ^(.*)         icong.myds.me:1208 redirect;
        return 301              icong.myds.me:1208;
    }

    error_page 404 /i_404.html;
    location = /i_404.html {
            root /root/nginx/www/error_page;
    }

    error_page 500 502 503 504 /i_50x.html;
    location = /i_50x.html {
            root /root/nginx/www/error_page;
    }
}